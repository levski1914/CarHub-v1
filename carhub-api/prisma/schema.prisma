datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id               String         @id @default(cuid())
  email            String         @unique
  passwordHash     String
  createdAt        DateTime       @default(now())
  refreshTokens    RefreshToken[]
  refreshTokenHash String? // nullable
  historyEvents    HistoryEvent[]
  vehicles         Vehicle[] // üëà –¥–æ–±–∞–≤–∏
  documents        Document[]

  emailVerified     Boolean   @default(false)
  emailVerifyToken  String?
  emailVerifySentAt DateTime?

  notificationSettings NotificationSettings?
  notificationLogs     NotificationLog[]
  inboxNotifications   InboxNotification[]
}

model HistoryEvent {
  id           String  @id @default(cuid())
  userId       String
  vehicleId    String?
  obligationId String?
  documentId   String?

  kind        String // "doc_uploaded" | "doc_deleted" | ...
  title       String
  description String?
  meta        Json?

  createdAt DateTime @default(now())

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  vehicle    Vehicle?    @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  obligation Obligation? @relation(fields: [obligationId], references: [id], onDelete: Cascade)
  document   Document?   @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([vehicleId, createdAt])
  @@index([obligationId, createdAt])
  @@index([documentId, createdAt])
}

model Vehicle {
  id        String     @id @default(cuid())
  plate     String
  make      String
  model     String
  createdAt DateTime   @default(now())
  documents Document[]
  userId    String // üëà –¥–æ–±–∞–≤–∏
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade) // üëà –¥–æ–±–∞–≤–∏

  obligations      Obligation[]
  notificationLogs NotificationLog[]
  historyEvents    HistoryEvent[]
}

model Obligation {
  id        String         @id @default(cuid())
  vehicleId String
  vehicle   Vehicle        @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  documents Document[]
  type      ObligationType
  dueDate   DateTime
  createdAt DateTime       @default(now())

  // NEW
  source           String            @default("manual") // "manual" | "integration"
  checkedAt        DateTime?
  meta             Json?
  // ‚úÖ back-relations
  notificationLogs NotificationLog[]
  historyEvents    HistoryEvent[]

  @@unique([vehicleId, type])
}

model NotificationSettings {
  id           String  @id @default(cuid())
  userId       String  @unique
  emailEnabled Boolean @default(false)
  smsEnabled   Boolean @default(false)
  email        String?
  phone        String?

  // –Ω–∞–ø—Ä. [7,3,1]
  daysBefore Int[] @default([7, 3, 1])

  // –∫–æ–≥–∞ –¥–∞ –ø—Ä–∞—â–∞–º–µ (–ª–æ–∫–∞–ª–Ω–æ –∑–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è)
  sendHour   Int    @default(9)
  sendMinute Int    @default(0)
  timezone   String @default("Europe/Sofia")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  tokenHash String
  revoked   Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Document {
  id           String  @id @default(cuid())
  userId       String
  vehicleId    String?
  obligationId String?

  name       String
  mimeType   String
  sizeBytes  Int
  storageKey String

  category DocumentCategory

  createdAt DateTime @default(now())

  user          User           @relation(fields: [userId], references: [id])
  vehicle       Vehicle?       @relation(fields: [vehicleId], references: [id])
  obligation    Obligation?    @relation(fields: [obligationId], references: [id])
  historyEvents HistoryEvent[]

  @@index([userId])
  @@index([vehicleId])
  @@index([obligationId])
}

model NotificationLog {
  id           String @id @default(cuid())
  userId       String
  vehicleId    String
  obligationId String

  channel      String // "email" | "sms"
  kind         String // "before_due" | "overdue"
  scheduledFor DateTime
  sentAt       DateTime?
  status       String // "queued" | "sent" | "failed"
  error        String?

  // –∑–∞ –¥–∞ –Ω–µ –ø—Ä–∞—â–∞–º–µ 2 –ø—ä—Ç–∏ –∑–∞ —Å—ä—â–æ—Ç–æ –Ω–µ—â–æ
  dedupeKey String @unique

  createdAt DateTime @default(now())

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  vehicle    Vehicle    @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  obligation Obligation @relation(fields: [obligationId], references: [id], onDelete: Cascade)
}

model InboxNotification {
  id     String @id @default(cuid())
  userId String

  // "reminder" | "system" | "activity"
  type  String
  title String
  body  String?
  href  String?
  meta  Json?

  // –∑–∞ –¥–∞ –Ω–µ —Å–ø–∞–º–∏–º —Å–∏—Å—Ç–µ–º–Ω–∏ (email unverified / notifications off)
  dedupeKey String? @unique

  readAt    DateTime?
  deletedAt DateTime?

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([userId, readAt])
  @@index([userId, deletedAt])
}

enum ObligationType {
  GO
  GTP
  TAX
  VIGNETTE
}

enum DocumentCategory {
  GO
  GTP
  VIGNETTE
  TAX
  CREDIT
  SERVICE
  OTHER
}
